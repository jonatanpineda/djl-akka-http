package djlakkahttpexample

//#test-top
import akka.actor.testkit.typed.scaladsl.ActorTestKit
import akka.http.scaladsl.marshalling.Marshal
import akka.http.scaladsl.model._
import akka.http.scaladsl.testkit.{RouteTestTimeout, ScalatestRouteTest}
import akka.testkit.TestDuration
import djlakkahttpexample.DjlInference.InferenceRequest
import org.scalatest.concurrent.ScalaFutures
import org.scalatest.{Matchers, WordSpec}

import scala.concurrent.duration.DurationInt

//#set-up
class DJLRoutesSpec extends WordSpec with Matchers with ScalaFutures with ScalatestRouteTest {
  //#test-top


  implicit val timeout = RouteTestTimeout(60.seconds.dilated)

  // the Akka HTTP route testkit does not yet support a typed actor system (https://github.com/akka/akka-http/issues/2036)
  // so we have to adapt for now
  lazy val testKit = ActorTestKit()
  implicit def typedSystem = testKit.system
  override def createActorSystem(): akka.actor.ActorSystem =
    testKit.system.classicSystem

  val inference = testKit.spawn(DjlInference())
  lazy val routes = new DJLRoutes(inference).djlRoutes

  // use the json formats to marshal and unmarshall objects in the test
  import akka.http.scaladsl.marshallers.sprayjson.SprayJsonSupport._
  import JsonFormats._
  //#set-up

  //#actual-test
  "DJLRoutes" should {
    //#actual-test

    //#testing-post
    "be able to perform djl inference (POST /inferences)" in {
      val text = "Hello World"
      val textEntity = Marshal(InferenceRequest(text="hello world")).to[MessageEntity].futureValue // futureValue is from ScalaFutures

      // using the RequestBuilding DSL:
      val request = Post("/inferences").withEntity(textEntity)

      request ~> routes ~> check {
        status should ===(StatusCodes.OK)

        // we expect the response to be json:
        contentType should ===(ContentTypes.`application/json`)

        // and we know what message we're expecting back:
        entityAs[String] should ===("""{"vector":"Array(-0.026074253, -0.08460002, -0.026786651, 0.05678421, 0.061970428, 0.03822599, 0.020114977, 0.027408728, 0.0869832, 0.030791812, 0.041041173, 0.025518332, 9.65181E-4, 0.058927972, 0.040095396, 0.046708945, -0.033127956, 0.040704187, -0.011993006, -0.04761707, -0.008296668, 0.070546746, 0.0048435517, 0.08098248, -0.057017714, -0.06435514, 0.069714725, -0.06988382, 0.026460629, -0.023522029, 0.055237535, 0.049136408, 0.056989722, -0.061071936, 0.036085114, 0.0232446, 0.05601751, -0.010955178, 0.04213085, -0.01769538, 0.007124322, 0.02047031, -0.071012646, -0.08455775, 0.04360583, 0.047939766, -0.09018021, -0.06873438, 0.012795961, 0.016249865, -0.048313115, 0.03088323, 0.007438376, 0.033915572, 0.033234395, 0.04331823, 0.06363337, 0.04920268, -0.02831084, 0.008135133, 0.06135313, -0.045509137, 0.07290055, 0.023510534, 0.03833481, 0.05084948, 0.008064042, 0.008628969, 0.064024195, -0.06050408, -0.07367949, 0.026957065, -0.057767615, 0.012501363, -0.040830847, 0.033285923, -0.03236125, -0.016109288, -0.02486771, -0.053566195, -0.037462775, 0.06290361, -0.049867198, -0.022866605, 0.04408273, 0.037532765, -0.06208244, 0.04283815, -0.037611637, 0.02658501, -0.053295903, 0.008691643, -0.046280053, 0.063702375, -0.0036636838, 0.036433637, 0.01210661, 0.023012504, -0.012787182, -0.08179381, 0.04632075, -0.051617734, -0.011576369, -0.04452023, 0.03644441, -0.006700764, -0.044253584, 0.04886803, -0.0070586083, -0.053173993, -0.050316863, 0.05561848, -0.052543893, 0.019667612, 0.05111387, 0.04785903, -0.044489697, 7.928247E-4, 0.023618594, 0.064666234, -0.006732705, -0.022291103, -0.04319403, 0.042283155, -0.03808259, 0.001302382, 0.07338936, 0.009224148, 0.05112649, 0.052876618, 0.0015942061, 0.065444745, 0.068991385, -0.00969, -0.0053836824, -0.08520418, -0.021374408, -0.0666425, -0.019566905, -0.0037444117, -0.017849369, -0.01986821, 0.03185364, 0.045190834, 0.00249815, -0.09529236, 0.0010956182, 0.03675926, -0.002779819, 5.8517844E-4, 0.052781656, -0.019537456, -0.057361864, 0.03485355, -0.076295905, 0.0011336316, 0.004932048, -0.06268555, -0.03726692, -0.02899792, 0.015442482, -0.011095521, -0.03563462, 0.009362221, 0.056058243, 0.023355754, 0.0036989402, -0.08498697, 0.04204438, -0.06589916, 0.007924899, 0.02030641, -0.011373894, -0.0048008724, -0.0658504, -0.0313581, -0.017683348, -0.031146187, 0.025776595, -0.06424093, 0.05484085, -0.033130713, -0.02062425, -0.026373157, -0.020302096, 0.020649364, 0.028162817, -0.058369987, 0.05959192, -0.0091468915, 0.0029574467, 0.0022116303, 0.09037653, 0.024593884, 0.033232853, -0.06097341, 0.043360267, 0.09327678, -0.05416611, -0.014382463, -0.06397153, -0.026916966, 0.059626132, 0.04668962, -0.027099533, 0.04303595, 0.039344985, 0.06830989, -0.06436641, 0.04373962, 0.071730606, -0.01633108, 0.015916515, 0.049694322, -0.020629976, 0.051480293, -0.025114283, -0.0453334, 0.014942506, 0.035300713, -0.021653365, 0.05526296, 0.050835375, -0.040951636, -0.03838469, -0.011798469, -0.036006074, 0.021676462, 0.03756439, 0.0016952747, -0.009027641, -0.022670943, 0.027483346, 0.096481904, -0.002789875, -0.016437842, 0.056487158, -0.060252964, -0.022318624, 0.008589218, -0.009621259, 0.014176718, 0.057966005, -0.056324225, 0.017024344, 0.04202541, -0.0075956355, -0.036660716, 0.034312446, 0.069016576, -0.07241283, 0.020756567, -0.0032847198, 0.011361107, 0.087960474, -0.07997253, -0.00296543, -0.019295262, -0.010338816, -0.046987943, 0.038407944, 0.023984984, 0.020890176, -0.038268823, -0.057562426, 0.017249689, 0.04097399, 5.9867394E-4, 0.016812371, 0.06323704, -0.042763434, 0.08113413, 0.0458502, 0.008916672, 0.032786965, 0.03617601, 0.0031024287, 0.065534666, 0.07671644, 0.09133661, 0.020614676, 0.010621679, 0.03598575, 0.045419365, -0.034675237, -0.016710652, 0.02144919, 0.009387992, -0.062412955, -0.018583585, 0.03705315, -0.038828406, -0.02596186, 0.029238062, -0.014491309, -0.0037462655, 0.030293966, 0.054067943, 0.047752403, 0.052931722, -0.043947484, -0.012863142, -0.0067732744, -0.04939049, -0.07270621, 0.01612875, 0.05462946, 0.0268698, 0.029914644, 0.0015510909, 0.027535956, -0.046426255, 0.03220915, 0.0026606016, 0.011994426, 0.043157585, 0.046660647, 0.052251358, -0.019322192, -0.016627876, -0.002711164, 1.5447606E-5, -0.008146151, 0.021495085, -0.0011832798, 0.037365623, -0.025614278, 0.076112926, 0.02441042, 0.03923673, 0.07120051, -0.005250851, 0.05436193, -0.062292732, -0.029423194, -0.03298631, 0.065658286, 0.07217148, 0.02687815, -0.02931616, -0.033296287, -0.08442488, -0.031601567, 0.027986769, -0.082374476, 0.036478877, 0.048825245, -0.068378344, 0.03186693, 0.016610749, 0.022978209, -0.061219744, -0.019339848, 0.05137832, 0.040758383, -0.033307545, -0.088700585, 0.0056609544, -0.06409236, -0.018600747, 0.062570825, -0.009901749, 0.06619704, 0.033872552, -0.0078023225, 0.034891225, -0.03666703, 0.07216833, -0.003654997, 0.024553623, 0.009418127, -0.064164825, 0.064555645, 0.053329453, -0.07750775, 0.08187079, 0.07886422, -0.05496588, 0.022272496, -0.088920124, -0.0262606, 0.017320456, 0.031656675, 0.018799296, 0.08769145, 0.05271847, -0.08660785, -0.02063366, 0.010211325, 0.07171678, 0.030014299, -0.010289536, 0.00414279, -0.008376689, -0.04638092, 0.016740842, -0.042826124, -0.0026100567, 0.06407275, 0.06881733, 0.010370593, 0.05199924, -0.005155602, -0.0027100085, 0.0014835295, -0.04150601, 0.0062554944, -0.0425069, 0.035888508, -0.02735906, -0.057205793, -0.013498383, -0.011188285, 0.028890066, -0.06438866, 0.038106583, 0.015930742, 0.08235063, -0.050688174, 0.055876024, -0.027931975, 0.049860176, -0.07185064, -0.004425495, 0.060467295, 0.084677644, -0.038332134, 0.05733055, -0.03558837, 0.050944485, 0.013083382, -0.06831689, -0.056430463, 0.03758243, -0.011389207, -0.015079115, -0.031533472, 0.016647087, 0.05050455, -0.07166415, 0.05062079, 0.008921254, -0.03951226, 0.030369213, -0.030768737, 0.0069180303, 0.024604518, -0.04057934, -0.06493127, -0.04283571, -0.043903835, 0.018041309, 0.08501027, -0.007997928, -0.035488468, -0.038543083, -0.0143462615, -0.034455515, 0.08241596, -0.022365985, -0.014782563, -0.03746162, -0.043876432, -0.069546394, -0.025264436, -0.034467798, -0.0059664557, -0.018487101, -0.024784915, 0.07087414, 0.016444203, 0.04182164, 0.07817083, 0.06507375, -0.04841202, -0.0501155, -0.05786818, -0.034813963, 0.009954485, 0.042034633, -0.054698907, 0.015208797, 0.07733308, -0.010855318, -0.012946772, 0.064838305, -0.02483453, -0.028243966, 0.017464515, -0.015176986, -0.04958215, -0.08010081, -0.013734391, 0.031738408, 0.05672605, 0.037241388, -0.020302195, 0.007136357, 0.08141144, -0.034604095, 0.0024751239, -0.024861569, -0.062247593, -0.07915096, -0.033903006, 0.070375785, -0.010907861, -0.026008243, -0.043663923, -0.021735718, 0.012625169, -0.06147427)"}""".stripMargin)
      }
    }
    //#testing-post

  }
  //#actual-test

  //#set-up
}
//#set-up
